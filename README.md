# Real-Time Video Mosaic

Система создания панорам из видео в реальном времени с обнаружением объектов и построением навигационных карт.

## Описание

Real-Time Video Mosaic - это проект для создания панорамных изображений (мозаик) из видеофайлов с использованием компьютерного зрения. Система автоматически сшивает последовательные кадры видео в единую панораму, обнаруживает объекты (люди, автомобили и др.) с помощью YOLOv8 и создаёт навигационные карты с построением маршрутов к обнаруженным объектам.

## Возможности

- ✅ Создание панорам из видео в реальном времени
- ✅ Поддержка детекторов SIFT и ORB для сопоставления ключевых точек
- ✅ Обнаружение объектов с помощью YOLOv8 (люди, автомобили, животные и др.)
- ✅ Автоматическое построение навигационных карт
- ✅ Алгоритм A* для построения маршрутов с обходом препятствий
- ✅ Графический интерфейс пользователя (GUI) на базе CustomTkinter
- ✅ Режим командной строки (CLI) для автоматизации
- ✅ Визуализация процесса формирования мозаики
- ✅ Сохранение результатов в виде изображений

## Системные требования

### Минимальные требования:
- **ОС:** Windows 10/11, Linux (Ubuntu 20.04+), macOS 10.15+
- **Python:** 3.8 или новее
- **RAM:** 8 GB (рекомендуется 16 GB)
- **Свободное место на диске:** 2 GB

### Рекомендуемые требования:
- **RAM:** 16 GB или более
- **GPU:** NVIDIA GPU с поддержкой CUDA (для ускорения YOLOv8)
- **Процессор:** Intel Core i5 или AMD Ryzen 5 и выше

## Установка

### 1. Клонирование репозитория

```bash
git clone https://github.com/PROcessorI/Real-Time-Video-Mosaic.git
cd Real-Time-Video-Mosaic
```

### 2. Создание виртуального окружения (рекомендуется)

#### Windows:
```bash
python -m venv venv
venv\Scripts\activate
```

#### Linux/macOS:
```bash
python3 -m venv venv
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

#### Список зависимостей:
- `opencv-python` - библиотека компьютерного зрения
- `numpy` - математические операции с массивами
- `ultralytics` - YOLOv8 для обнаружения объектов
- `pathfinding` - алгоритмы поиска пути (A*)
- `Pillow` - работа с изображениями
- `customtkinter` - современный GUI для Python

### 4. Загрузка моделей YOLOv8

Модели YOLOv8 загружаются автоматически при первом запуске. Проект использует `yolov8n.pt` (nano модель) по умолчанию. В репозитории уже присутствуют модели:
- `yolov8n.pt` - самая быстрая, используется по умолчанию
- `yolov8s.pt` - малая модель
- `yolov8l.pt` - большая модель (более точная, но медленнее)

## Использование

### Графический интерфейс (GUI)

Запуск приложения с графическим интерфейсом:

```bash
python gui.py
```

**Инструкция:**
1. Нажмите кнопку **"Выбрать видео"** и выберите видеофайл
2. Нажмите **"Запустить обработку"**
3. Наблюдайте за процессом формирования мозаики в реальном времени
4. После завершения обработки вы увидите:
   - Финальную панораму
   - Навигационную карту с маршрутами
   - Список кадров с обнаруженными объектами

### Режим командной строки (CLI)

Запуск обработки видео через командную строку:

```bash
python main.py
```

По умолчанию программа обработает видео `Data/поиски квадрокоптера 2 (360p) 03.mp4`.

#### Изменение входного видео

Отредактируйте файл `main.py`, изменив путь к видео в функции `main()`:

```python
if __name__ == "__main__":
    main(video_path='путь/к/вашему/видео.mp4')
```

Или измените строку 639 в `main.py`:
```python
video_path = 'Data/поиски квадрокоптера 2 (360p) 03.mp4'
```

### Результаты работы

После завершения обработки в корневой директории появятся файлы:

- **`mosaic.jpg`** - итоговая панорама
- **`navigation_map.jpg`** - карта с маршрутами навигации
- **`Detections/`** - папка с кадрами, содержащими обнаруженные объекты

## Структура проекта

```
Real-Time-Video-Mosaic/
├── main.py                 # Основной модуль обработки видео
├── gui.py                  # Графический интерфейс
├── requirements.txt        # Список зависимостей
├── Data/                   # Папка с видеофайлами
│   ├── поиски квадрокоптера 2 (360p) 01.mp4
│   ├── поиски квадрокоптера 2 (360p) 02.mp4
│   └── поиски квадрокоптера 2 (360p) 03.mp4
├── Detections/             # Создаётся автоматически - кадры с детекциями
├── yolov8n.pt              # Модель YOLOv8 nano
├── yolov8s.pt              # Модель YOLOv8 small
├── yolov8l.pt              # Модель YOLOv8 large
├── mosaic.jpg              # Результат - панорама (создаётся после обработки)
└── navigation_map.jpg      # Результат - навигационная карта
```

## Описание основных модулей

### `main.py`

Основной модуль, содержащий:

- **`VideMosaic`** - класс для создания панорам из видео
  - `__init__()` - инициализация детектора признаков (SIFT/ORB) и модели YOLOv8
  - `process_frame()` - обработка каждого кадра видео
  - `detect_people()` - обнаружение людей на кадре
  - `detect_objects()` - обнаружение различных объектов
  - `findHomography()` - вычисление гомографии между кадрами
  - `warp()` - трансформация кадра и добавление в мозаику

- **`analyze_for_navigation()`** - анализ мозаики для построения навигационной карты
  - Обнаружение препятствий (по цвету)
  - Обнаружение зданий и крупных объектов
  - Построение маршрутов с помощью A*
  - Визуализация маршрутов

- **`main()`** - основная функция обработки видео

### `gui.py`

Графический интерфейс на базе CustomTkinter:

- Выбор видеофайла
- Отображение прогресса обработки
- Визуализация текущей мозаики в реальном времени
- Отображение финальных результатов
- Просмотр обнаруженных объектов

## Настройка параметров

### Изменение детектора признаков

В `main.py`, строка 666:
```python
video_mosaic = VideMosaic(frame_cur, detector_type="sift")
```

Варианты: `"sift"` (рекомендуется) или `"orb"` (быстрее, но менее точно).

### Изменение размера выходной мозаики

В `main.py`, строка 12:
```python
def __init__(self, first_image, output_height_times=3, output_width_times=1.2, ...):
```

- `output_height_times` - множитель высоты (по умолчанию 3)
- `output_width_times` - множитель ширины (по умолчанию 1.2)

### Изменение модели YOLOv8

В `main.py`, строка 35:
```python
self.model = YOLO('yolov8n.pt')  # Можно изменить на yolov8s.pt или yolov8l.pt
```

Доступные модели:
- `yolov8n.pt` - nano (быстрая, ~3MB)
- `yolov8s.pt` - small (~11MB)
- `yolov8m.pt` - medium (~25MB) - нужно скачать отдельно
- `yolov8l.pt` - large (~43MB, более точная)
- `yolov8x.pt` - extra large (~68MB) - нужно скачать отдельно

### Настройка порогов обнаружения

В `main.py`, метод `detect_objects()`, строка 102:
```python
results = self.model.predict(
    resized,
    conf=0.4,      # порог уверенности (0.0-1.0)
    iou=0.45,      # порог IoU для NMS
    imgsz=640,     # размер изображения для детекции
    verbose=False
)
```

## Примеры использования

### Пример 1: Обработка своего видео через CLI

1. Поместите видеофайл в папку `Data/`
2. Откройте `main.py`
3. Измените строку 639:
   ```python
   video_path = 'Data/ваш_файл.mp4'
   ```
4. Запустите:
   ```bash
   python main.py
   ```

### Пример 2: Использование GUI

```bash
python gui.py
```
Выберите видео через интерфейс и нажмите "Запустить обработку".

### Пример 3: Программное использование

```python
from main import VideMosaic, main
import cv2

# Способ 1: Использование функции main
main(video_path='Data/ваше_видео.mp4', show_intermediate=False)

# Способ 2: Программное использование класса VideMosaic
cap = cv2.VideoCapture('Data/ваше_видео.mp4')
ret, first_frame = cap.read()

mosaic = VideMosaic(first_frame, detector_type="sift")

while cap.isOpened():
    ret, frame = cap.read()
    if not ret:
        break
    mosaic.process_frame(frame, frame_count=0)

cap.release()
cv2.imwrite('результат.jpg', mosaic.output_img)
```

## Устранение неполадок

### Проблема: "Ошибка: Не удалось открыть видеофайл"

**Решение:**
- Проверьте, что путь к видеофайлу указан правильно
- Убедитесь, что файл существует
- Проверьте формат видео (поддерживаются: mp4, avi, mov)

### Проблема: "Warning: failed to load YOLO model"

**Решение:**
1. Убедитесь, что пакет `ultralytics` установлен:
   ```bash
   pip install ultralytics
   ```
2. Проверьте наличие файла модели `yolov8n.pt` в корневой директории
3. При первом запуске модель загружается автоматически - требуется интернет-соединение

### Проблема: Медленная обработка видео

**Решение:**
- Используйте более лёгкую модель YOLO (`yolov8n.pt` вместо `yolov8l.pt`)
- Уменьшите разрешение входного видео
- Используйте GPU (установите `torch` с поддержкой CUDA):
  ```bash
  pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
  ```

### Проблема: Ошибки при работе с кириллицей в путях

**Решение:**
- Используйте английские названия файлов и путей
- Или убедитесь, что локаль системы поддерживает UTF-8

### Проблема: GUI не запускается

**Решение:**
1. Проверьте, что `customtkinter` установлен:
   ```bash
   pip install customtkinter
   ```
2. На Linux может потребоваться установка tkinter:
   ```bash
   sudo apt-get install python3-tk
   ```

### Проблема: Чёрные области в мозаике

Это нормальное поведение - чёрные области возникают там, где не было видеоданных. Функция `crop_black_areas()` автоматически обрезает их в финальном результате.

### Проблема: Недостаточно памяти

**Решение:**
- Уменьшите параметры `output_height_times` и `output_width_times`
- Обрабатывайте видео меньшего разрешения
- Закройте другие приложения

## Дополнительная информация

### Используемые алгоритмы

- **SIFT/ORB** - для извлечения и сопоставления ключевых точек
- **RANSAC** - для устойчивого вычисления гомографии
- **YOLOv8** - для обнаружения объектов в реальном времени
- **A*** - для построения оптимальных маршрутов на навигационной карте
- **Perspective Transform** - для трансформации и склейки кадров

### Форматы видео

Поддерживаются все форматы, поддерживаемые OpenCV:
- MP4 (H.264, HEVC)
- AVI
- MOV
- MKV
- WEBM

### Производительность

Типичная скорость обработки на Intel Core i5 + 16GB RAM:
- Видео 360p: ~10-15 FPS
- Видео 720p: ~5-8 FPS
- Видео 1080p: ~2-4 FPS

С GPU (CUDA) скорость может быть выше в 3-5 раз.

## Лицензия

Этот проект является открытым. Вы можете свободно использовать, изменять и распространять его.

## Контакты и поддержка

Если у вас возникли вопросы или проблемы:
- Создайте Issue на GitHub: https://github.com/PROcessorI/Real-Time-Video-Mosaic/issues
- Отправьте Pull Request с улучшениями

## Благодарности

Проект использует следующие библиотеки:
- OpenCV - компьютерное зрение
- Ultralytics YOLOv8 - обнаружение объектов
- CustomTkinter - современный GUI
- pathfinding - алгоритмы поиска пути

---

**Версия:** 1.0  
**Последнее обновление:** 2024
